"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[273],{"./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/SendWysiwygComposer.tsx":(e,t,n)=>{n.r(t),n.d(t,{default:()=>j});var o=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),s=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=n("./node_modules/react/index.js"),i=n("./node_modules/matrix-react-sdk/src/dispatcher/dispatcher.ts"),c=n("./node_modules/matrix-react-sdk/src/dispatcher/actions.ts"),l=n("./node_modules/matrix-react-sdk/src/contexts/RoomContext.ts"),a=n("./node_modules/matrix-react-sdk/src/hooks/useDispatcher.ts"),d=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/utils.ts"),u=n("./node_modules/matrix-react-sdk/src/dispatcher/payloads/ComposerInsertPayload.ts"),m=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/ComposerContext.ts"),f=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/selection.ts");var p=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/WysiwygComposer.tsx"),g=n("./node_modules/classnames/index.js"),h=n.n(g);var x=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/useIsFocused.ts");var v=n("./node_modules/matrix-react-sdk/src/hooks/useSettings.ts"),y=n("./node_modules/matrix-react-sdk/src/Keyboard.ts"),C=n("./node_modules/matrix-js-sdk/src/logger.ts"),k=n("./node_modules/matrix-react-sdk/src/Typeguards.ts");function w(e,t){var n;const[o,s]=(0,r.useState)(null),i=e=>{C.v.log(`## 26037 ## wysiwyg useSuggestion hook setting suggestion data to ${null===e||e instanceof Function?e:e.mappedSuggestion.keyChar+e.mappedSuggestion.text}`),s(e)};return{suggestion:null!==(n=null==o?void 0:o.mappedSuggestion)&&void 0!==n?n:null,handleCommand:e=>function(e,t,n,o){var s;if(null===t)return;const{node:r}=t,i=`${e} `;r.textContent=i,null===(s=document.getSelection())||void 0===s||s.setBaseAndExtent(r,i.length,r,i.length),o(i),n(null)}(e,o,i,t),handleMention:(e,n,s)=>_(e,n,s,o,i,t),handleAtRoomMention:e=>_("#","@room",e,o,i,t),onSelect:()=>function(e,t){var n;const o=document.getSelection();if(null===e.current||null===o||!o.isCollapsed||"#text"!==(null===(n=o.anchorNode)||void 0===n?void 0:n.nodeName))return void t(null);const{anchorNode:s,anchorOffset:r}=o;if(null===s.textContent)return void t(null);const i=document.createNodeIterator(e.current,NodeFilter.SHOW_TEXT).nextNode(),c=s===i,l=function(e,t,n){if(t<0||t>e.length)return null;let o=t,s=t;for(;b(e,o);)o--;for(;S(e,s);)s++;const r=e.slice(o,s),i=function(e){const t=e.charAt(0),n=e.slice(1);switch(t){case"/":return{keyChar:t,text:n,type:"command"};case"#":case"@":return{keyChar:t,text:n,type:"mention"};default:return null}}(r);if(null===i||"command"===i.type&&(!n||0!==o||s!==e.length))return null;return{mappedSuggestion:i,startOffset:o,endOffset:o+r.length}}(s.textContent,r,c);if(null===l)return void t(null);t({mappedSuggestion:l.mappedSuggestion,node:s,startOffset:l.startOffset,endOffset:l.endOffset})}(e,i)}}function _(e,t,n,o,s,r){var i,c,l,a;if(null===o)return;const{node:d}=o,u=document.createElement("a"),m=document.createTextNode(t);u.setAttribute("href",e),u.setAttribute("contenteditable","false");for(const[e,t]of n.entries())u.setAttribute(e,t);u.appendChild(m);const f=document.createTextNode((null===(i=d.textContent)||void 0===i?void 0:i.slice(0,o.startOffset))||"â€‹"),p=document.createTextNode(` ${null!==(c=null===(l=d.textContent)||void 0===l?void 0:l.slice(o.endOffset))&&void 0!==c?c:""}`),g=d.parentNode;(0,k.P)(g)&&(g.insertBefore(f,d),g.insertBefore(u,d),g.insertBefore(p,d),g.removeChild(d)),null===(a=document.getSelection())||void 0===a||a.setBaseAndExtent(p,1,p,1),r(),s(null)}function b(e,t){return!(t<=0)&&!/\s/.test(e[t-1])}function S(e,t){return!(t>=e.length)&&!/\s/.test(e[t])}var E=n("./node_modules/matrix-react-sdk/src/contexts/MatrixClientContext.tsx");function T(e,t,n,o){const s=(0,l.mP)(),i=(0,E.nH)(),c=(0,r.useRef)(null),a=(0,r.useRef)(null),[u,m]=(0,r.useState)(e),f=(0,r.useCallback)((()=>{c.current&&(c.current.innerHTML=""),null==n||n()}),[c,n]),p=(0,r.useCallback)((e=>{if((0,k.E)(e))m(e),null==t||t(e);else if((0,k.P)(c)&&(0,k.P)(c.current)){const e=c.current.innerHTML;m(e),null==t||t(e)}}),[t,c]),{suggestion:g,onSelect:h,handleCommand:x,handleMention:C,handleAtRoomMention:_}=w(c,p),b=(0,r.useCallback)((e=>{e.target instanceof HTMLDivElement&&p(e.target.innerHTML)}),[p]),S=(0,r.useCallback)((e=>{const{nativeEvent:t}=e;let n=!1;if((0,d.wg)(t)){const e=t instanceof ClipboardEvent?t.clipboardData:t.dataTransfer;n=(0,d.VI)(t,e,s,i,o)}n?e.preventDefault():b(e)}),[o,i,b,s]),T=!(0,v.t)("MessageComposerInput.ctrlEnterToSend"),R=(0,r.useCallback)((e=>{if(!(0,d.hi)(a,e)&&e.key===y.Uz.ENTER){const t=y.vL?e.metaKey:e.ctrlKey;T&&!e.shiftKey&&(e.preventDefault(),e.stopPropagation(),f()),!T&&t&&(e.preventDefault(),e.stopPropagation(),f())}}),[a,T,f]);return{ref:c,autocompleteRef:a,onBeforeInput:S,onInput:b,onPaste:S,onKeyDown:R,content:u,setContent:p,suggestion:g,onSelect:h,handleCommand:x,handleMention:C,handleAtRoomMention:_}}var R=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/useSetCursorPosition.ts"),M=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/Editor.tsx"),A=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/WysiwygAutocomplete.tsx");function P({className:e,disabled:t=!1,onSend:n,onChange:o,children:s,placeholder:i,initialContent:c,leftComponent:l,rightComponent:a,eventRelation:d}){const{ref:u,autocompleteRef:m,onBeforeInput:p,onInput:g,onPaste:v,onKeyDown:y,content:C,setContent:k,suggestion:w,onSelect:_,handleCommand:b,handleMention:S,handleAtRoomMention:E}=T(c,o,n,d),P=function(e,t){return(0,r.useMemo)((()=>({clear:()=>{e.current&&(e.current.innerHTML="")},insertText:n=>{const o=document.getSelection();if(e.current&&o){const s=e.current.innerHTML,{anchorOffset:r,focusOffset:i}=o;e.current.innerHTML=`${s.slice(0,r)}${n}${s.slice(i)}`,(0,f.td)({anchorNode:e.current.firstChild,anchorOffset:r+n.length,focusNode:e.current.firstChild,focusOffset:i+n.length,isForward:!0}),t(e.current.innerHTML)}}})),[e,t])}(u,k);!function(e="",t){(0,r.useEffect)((()=>{t.current&&(t.current.innerHTML=e)}),[t,e])}(c,u),(0,R.V)(t,u);const{isFocused:N,onFocus:I}=(0,x.j)(),H=!C&&i||void 0;return r.createElement("div",{className:h()(e,{[`${e}-focused`]:N}),onFocus:I,onBlur:I,onBeforeInput:p,onInput:g,onPaste:v,onKeyDown:y,onSelect:_},r.createElement(A.W,{ref:m,suggestion:w,handleMention:S,handleCommand:b,handleAtRoomMention:E}),r.createElement(M.K,{ref:u,disabled:t,leftComponent:l,rightComponent:a,placeholder:H}),null==s?void 0:s(u,P))}var N=n("./node_modules/matrix-react-sdk/src/components/views/rooms/E2EIcon.tsx"),I=n("./node_modules/matrix-react-sdk/src/components/views/rooms/EmojiButton.tsx");function H({menuPosition:e}){const t=(0,l.mP)();return r.createElement(I.h,{menuPosition:e,addEmoji:e=>(i.Ay.dispatch({action:c.r.ComposerInsert,text:e,timelineRenderingType:t.timelineRenderingType}),!0)})}const O=["isRichTextEnabled","e2eStatus","menuPosition"],F=(0,r.forwardRef)((function({disabled:e=!1,composerFunctions:t},n){return function(e,t,n){const o=(0,l.mP)(),s=(0,m.Hx)(),p=(0,r.useRef)(null),g=(0,r.useCallback)((r=>{var i;if(e||null==t||!t.current)return;const a=null!==(i=r.context)&&void 0!==i?i:l.Ae.Room;switch(r.action){case"reply_to_event":case c.r.FocusAComposer:case c.r.FocusSendMessageComposer:(0,d.Hj)(t,a,o,p);break;case c.r.ClearAndFocusSendMessageComposer:if(r.timelineRenderingType!==o.timelineRenderingType)break;n.clear(),(0,d.Hj)(t,a,o,p);break;case c.r.ComposerInsert:if(r.timelineRenderingType!==o.timelineRenderingType)break;if(r.composerType!==u.D.Send)break;r.userId||r.event||r.text&&(0,f.td)(s.selection).then((()=>n.insertText(r.text)))}}),[e,t,o,n,s]);(0,a.F)(i.Ay,g)}(e,n,t),null}));function j(e){let{isRichTextEnabled:t,e2eStatus:n,menuPosition:i}=e,c=(0,s.A)(e,O);const l=t?p.k:P,a=(0,r.useRef)((0,m.AP)({eventRelation:c.eventRelation}));return r.createElement(m.EW.Provider,{value:a.current},r.createElement(l,(0,o.A)({className:"mx_SendWysiwygComposer",leftComponent:n&&r.createElement(N.A,{status:n}),rightComponent:r.createElement(H,{menuPosition:i})},c),((e,t)=>r.createElement(F,{disabled:c.disabled,ref:e,composerFunctions:t}))))}}}]);
//# sourceMappingURL=273.js.map