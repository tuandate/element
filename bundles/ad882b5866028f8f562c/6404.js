"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[6404],{"./node_modules/matrix-react-sdk/src/components/views/location/LocationPicker.tsx":(e,t,o)=>{o.r(t),o.d(t,{default:()=>A});var s=o("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=o("./node_modules/react/index.js"),i=o("./node_modules/maplibre-gl/dist/maplibre-gl.js"),n=o.n(i),a=o("./node_modules/matrix-js-sdk/src/logger.ts"),l=o("./node_modules/matrix-js-sdk/src/matrix.ts"),c=o("./node_modules/matrix-react-sdk/src/languageHandler.tsx"),d=o("./node_modules/matrix-react-sdk/src/contexts/MatrixClientContext.tsx"),m=o("./node_modules/matrix-react-sdk/src/Modal.tsx"),u=o("./node_modules/matrix-react-sdk/src/utils/WellKnownUtils.ts"),h=o("./node_modules/matrix-react-sdk/src/utils/beacon/index.ts"),p=o("./node_modules/matrix-react-sdk/src/utils/location/index.ts"),_=o("./node_modules/matrix-react-sdk/src/components/views/dialogs/ErrorDialog.tsx"),v=o("./node_modules/matrix-react-sdk/src/components/views/elements/AccessibleButton.tsx"),k=o("./node_modules/matrix-react-sdk/src/components/views/location/MapError.tsx"),g=o("./node_modules/matrix-react-sdk/src/DateUtils.ts"),x=o("./node_modules/matrix-react-sdk/src/components/views/elements/Dropdown.tsx");const L={fifteenMins:9e5,oneHour:36e5,eightHours:288e5},y=L.fifteenMins,f=e=>(0,c._t)("location_sharing|live_share_button",{duration:(0,g.a3)(e)}),b=({timeout:e,onChange:t})=>{const o=Object.values(L).map((e=>({key:e.toString(),duration:e,label:f(e)})));Object.values(L).includes(e)||o.push({key:e.toString(),duration:e,label:f(e)});return r.createElement(x.A,{id:"live-duration",label:f(e),value:e.toString(),onOptionChange:e=>{t(+e)},className:"mx_LiveDurationDropdown"},o.map((({key:e,label:t})=>r.createElement("div",{key:e},t))))};var M=o("./node_modules/matrix-react-sdk/src/components/views/location/shareLocation.ts"),C=o("./node_modules/matrix-react-sdk/src/components/views/location/Marker.tsx");const w=e=>e===M.L$.Own||e===M.L$.Live;class E extends r.Component{constructor(e){super(e),(0,s.A)(this,"context",void 0),(0,s.A)(this,"map",void 0),(0,s.A)(this,"geolocate",void 0),(0,s.A)(this,"marker",void 0),(0,s.A)(this,"getMarkerId",(()=>"mx_MLocationPicker_marker")),(0,s.A)(this,"addMarkerToMap",(()=>{var e;this.marker=new(n().Marker)({element:null!==(e=document.getElementById(this.getMarkerId()))&&void 0!==e?e:void 0,anchor:"bottom",offset:[0,-1]}).setLngLat(new(n().LngLat)(0,0)).addTo(this.map)})),(0,s.A)(this,"updateStyleUrl",(e=>{var t;const o=null===(t=(0,u.XP)(e))||void 0===t?void 0:t.map_style_url;var s;o&&(null===(s=this.map)||void 0===s||s.setStyle(o))})),(0,s.A)(this,"onGeolocate",(e=>{var t;this.marker||this.addMarkerToMap(),this.setState({position:(0,h.v9)(e)}),null===(t=this.marker)||void 0===t||t.setLngLat(new(n().LngLat)(e.coords.longitude,e.coords.latitude))})),(0,s.A)(this,"onClick",(e=>{var t;this.marker||this.addMarkerToMap(),null===(t=this.marker)||void 0===t||t.setLngLat(e.lngLat),this.setState({position:{timestamp:Date.now(),latitude:e.lngLat.lat,longitude:e.lngLat.lng}})})),(0,s.A)(this,"onGeolocateError",(e=>{var t;(a.v.error("Could not fetch location",e),w(this.props.shareType)&&(this.props.onFinished(),m.Ay.createDialog(_.A,{title:(0,c._t)("location_sharing|error_fetch_location"),description:(0,p.Ff)(e.code)})),this.geolocate)&&(null===(t=this.map)||void 0===t||t.removeControl(this.geolocate))})),(0,s.A)(this,"onTimeoutChange",(e=>{this.setState({timeout:e})})),(0,s.A)(this,"onOk",(()=>{const{timeout:e,position:t}=this.state;this.props.onChoose(t?{uri:(0,h.mt)(t),timestamp:t.timestamp,timeout:e}:{timeout:e}),this.props.onFinished()})),this.state={position:void 0,timeout:y,error:void 0}}componentDidMount(){this.context.on(l.ClientEvent.ClientWellKnown,this.updateStyleUrl);try{if(this.map=new(n().Map)({container:"mx_LocationPicker_map",style:(0,p.M0)(this.context),center:[0,0],zoom:1}),this.geolocate=new(n().GeolocateControl)({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1}),this.map.addControl(this.geolocate),this.map.on("error",(e=>{a.v.error("Failed to load map: check map_style_url in config.json has a valid URL and API key",e.error),this.setState({error:p.$X.MapStyleUrlNotReachable})})),this.map.on("load",(()=>{var e;null===(e=this.geolocate)||void 0===e||e.trigger()})),this.geolocate.on("error",this.onGeolocateError),w(this.props.shareType)&&this.geolocate.on("geolocate",this.onGeolocate),this.props.shareType===M.L$.Pin){const e=new(n().NavigationControl)({showCompass:!1,showZoom:!0});this.map.addControl(e,"bottom-right"),this.map.on("click",this.onClick)}}catch(e){a.v.error("Failed to render map",e);const t=null==e?void 0:e.message;let o;o=t===p.$X.MapStyleUrlNotConfigured?p.$X.MapStyleUrlNotConfigured:t.includes("Failed to initialize WebGL")?p.$X.WebGLNotEnabled:p.$X.Default,this.setState({error:o})}}componentWillUnmount(){var e,t,o;null===(e=this.geolocate)||void 0===e||e.off("error",this.onGeolocateError),null===(t=this.geolocate)||void 0===t||t.off("geolocate",this.onGeolocate),null===(o=this.map)||void 0===o||o.off("click",this.onClick),this.context.off(l.ClientEvent.ClientWellKnown,this.updateStyleUrl)}render(){return this.state.error?r.createElement("div",{className:"mx_LocationPicker mx_LocationPicker_hasError"},r.createElement(k.p,{error:this.state.error,onFinished:this.props.onFinished})):r.createElement("div",{className:"mx_LocationPicker"},r.createElement("div",{id:"mx_LocationPicker_map"}),this.props.shareType===M.L$.Pin&&r.createElement("div",{className:"mx_LocationPicker_pinText"},r.createElement("span",null,this.state.position?(0,c._t)("location_sharing|click_move_pin"):(0,c._t)("location_sharing|click_drop_pin"))),r.createElement("div",{className:"mx_LocationPicker_footer"},r.createElement("form",{onSubmit:this.onOk},this.props.shareType===M.L$.Live&&r.createElement(b,{onChange:this.onTimeoutChange,timeout:this.state.timeout}),r.createElement(v.A,{type:"submit",element:"button",kind:"primary",className:"mx_LocationPicker_submitButton",disabled:!this.state.position,onClick:this.onOk},(0,c._t)("location_sharing|share_button")))),r.createElement("div",{id:this.getMarkerId()},!!this.marker&&r.createElement(C.A,{roomMember:w(this.props.shareType)?this.props.sender:void 0,useMemberColor:this.props.shareType===M.L$.Live})))}}(0,s.A)(E,"contextType",d.Ay);const A=E},"./node_modules/matrix-react-sdk/src/components/views/location/Marker.tsx":(e,t,o)=>{o.d(t,{A:()=>d});var s=o("./node_modules/react/index.js"),r=o("./node_modules/classnames/index.js"),i=o.n(r),n=o("./node_modules/matrix-react-sdk/res/img/element-icons/location.svg"),a=o("./node_modules/matrix-react-sdk/src/utils/FormattingUtils.ts"),l=o("./node_modules/matrix-react-sdk/src/components/views/avatars/MemberAvatar.tsx");const c=({tooltip:e,children:t})=>{const[o,r]=(0,s.useState)(!1);if(!e)return s.createElement(s.Fragment,null,t);return s.createElement("div",{onMouseEnter:()=>r(!0),onClick:e=>{e.stopPropagation(),r(!o)},onMouseLeave:()=>r(!1)},t,o&&e)},d=s.forwardRef((({id:e,roomMember:t,useMemberColor:o,tooltip:r},d)=>{const m=o&&t?(0,a.yJ)(t.userId):"";return s.createElement("div",{ref:d,id:e,className:i()("mx_Marker",m,{mx_Marker_defaultColor:!m})},s.createElement(c,{tooltip:r},s.createElement("div",{className:"mx_Marker_border"},t?s.createElement(l.A,{member:t,size:"36px",viewUserOnClick:!1,hideTitle:!!r}):s.createElement(n.I,{className:"mx_Marker_icon"}))))}))},"./node_modules/matrix-react-sdk/src/components/views/location/shareLocation.ts":(e,t,o)=>{o.d(t,{$e:()=>p,L$:()=>m,tS:()=>h});var s=o("./node_modules/matrix-js-sdk/src/matrix.ts"),r=o("./node_modules/matrix-js-sdk/src/logger.ts"),i=o("./node_modules/matrix-react-sdk/src/languageHandler.tsx"),n=o("./node_modules/matrix-react-sdk/src/Modal.tsx"),a=o("./node_modules/matrix-react-sdk/src/components/views/dialogs/QuestionDialog.tsx"),l=o("./node_modules/matrix-react-sdk/src/SdkConfig.ts"),c=o("./node_modules/matrix-react-sdk/src/stores/OwnBeaconStore.ts"),d=o("./node_modules/matrix-react-sdk/src/utils/local-room.ts");let m=function(e){return e.Own="Own",e.Pin="Pin",e.Live="Live",e}({});const u=(e,t,o)=>{const{modalParams:s,errorMessage:c}="M_FORBIDDEN"===e.errcode?(e=>{const t=e===m.Live?"Insufficient permissions to start sharing your live location":"Insufficient permissions to send your location";return{modalParams:{title:(0,i._t)("location_sharing|error_no_perms_title"),description:(0,i._t)("location_sharing|error_no_perms_description"),button:(0,i._t)("action|ok"),hasCancelButton:!1,onFinished:()=>{}},errorMessage:t}})(o):((e,t)=>{const o=e===m.Live?"We couldn't start sharing your live location":"We couldn't send your location";return{modalParams:{title:(0,i._t)("location_sharing|error_send_title"),description:(0,i._t)("location_sharing|error_send_description",{brand:l.Ay.get().brand}),button:(0,i._t)("action|try_again"),cancelButton:(0,i._t)("action|cancel"),onFinished:e=>{e&&t()}},errorMessage:o}})(o,t);r.v.error(c,e),n.Ay.createDialog(a.A,s)},h=(e,t,o,r)=>async({timeout:e})=>{const n=(0,i._t)("location_sharing|live_description",{displayName:o});try{await c.g.instance.createLiveBeacon(t,s.ContentHelpers.makeBeaconInfoContent(null!=e?e:3e5,!0,n,s.LocationAssetType.Self))}catch(e){u(e,r,m.Live)}},p=(e,t,o,r,i)=>async({uri:n,timestamp:a})=>{if(n)try{const i=(null==r?void 0:r.rel_type)===s.THREAD_RELATION_TYPE.name&&(null==r?void 0:r.event_id)||null,l=o===m.Pin?s.LocationAssetType.Pin:s.LocationAssetType.Self,c=s.ContentHelpers.makeLocationContent(void 0,n,a,void 0,l);await(0,d.Y)(t,(t=>e.sendMessage(t,i,c)),e)}catch(e){u(e,i,o)}}}}]);
//# sourceMappingURL=6404.js.map