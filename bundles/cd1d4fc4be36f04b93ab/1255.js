"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[1255],{"./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/editing.ts":(e,t,n)=>{n.d(t,{r:()=>i,w:()=>a});var s=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./node_modules/matrix-react-sdk/src/dispatcher/dispatcher.ts"),o=n("./node_modules/matrix-react-sdk/src/dispatcher/actions.ts");function a(e){r.Ay.dispatch({action:o.r.EditEvent,event:null,timelineRenderingType:e.timelineRenderingType}),r.Ay.dispatch({action:o.r.FocusSendMessageComposer,context:e.timelineRenderingType})}function i(e,t){const n=t.getEvent().replacingEvent();!n||n.status!==s.EventStatus.QUEUED&&n.status!==s.EventStatus.NOT_SENT||e.cancelPendingEvent(n)}},"./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/message.ts":(e,t,n)=>{n.r(t),n.d(t,{editMessage:()=>R,sendMessage:()=>C});var s=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=n("./node_modules/matrix-js-sdk/src/matrix.ts"),o=n("./node_modules/matrix-react-sdk/src/PosthogAnalytics.ts"),a=n("./node_modules/matrix-react-sdk/src/settings/SettingsStore.ts"),i=n("./node_modules/matrix-react-sdk/src/sendTimePerformanceMetrics.ts"),c=n("./node_modules/matrix-react-sdk/src/utils/local-room.ts"),d=n("./node_modules/matrix-react-sdk/src/effects/index.ts"),l=n("./node_modules/matrix-react-sdk/src/effects/utils.ts"),m=n("./node_modules/matrix-react-sdk/src/dispatcher/dispatcher.ts"),u=n("./node_modules/matrix-react-sdk/src/components/views/dialogs/ConfirmRedactDialog.tsx"),p=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/editing.ts"),y=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),g=n("./node_modules/@matrix-org/matrix-wysiwyg/dist/matrix-wysiwyg.js"),f=n("./node_modules/matrix-react-sdk/src/utils/permalinks/Permalinks.ts"),_=n("./node_modules/matrix-react-sdk/src/utils/Reply.ts"),h=n("./node_modules/matrix-react-sdk/src/Typeguards.ts");function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){(0,y.A)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const b="/me ";const T=e=>e instanceof r.MatrixEvent;async function k(e,t,{relation:n,replyToEvent:s,permalinkCreator:o,includeReplyLegacyFallback:i=!0,editedEvent:c}){const d=T(c),l=d?Boolean(c.replyEventId):T(s),m=d&&l,u=e.startsWith(b);u&&(e=e.slice(b.length)),e.startsWith("//")&&(e=e.slice(1));const p=t?await(0,g.richToPlain)(e,!1):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach((e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const n=(0,f.$N)(t);(0,h.P)(n)&&(0,h.P)(n.roomIdOrAlias)&&e.replaceWith(n.roomIdOrAlias);break}}})),t.body.innerHTML}(e),y=m&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const n=t.split("\n").map((e=>e.trim()));return n.length>2&&n[0].startsWith("> ")&&0===n[1].length?`${n[0]}\n\n`:""}(c)||"",v=m&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(c)||"",k={msgtype:u?r.MsgType.Emote:r.MsgType.Text,body:d?`${y} * ${p}`:p},E=a.A.getValue("MessageComposerInput.useMarkdown"),w=t?e:E?await(0,g.plainToRich)(e,!0):null;w&&(k.format="org.matrix.custom.html",k.formatted_body=d?`${v} * ${w}`:w),d&&(k["m.new_content"]={msgtype:k.msgtype,body:p},w&&(k["m.new_content"].format="org.matrix.custom.html",k["m.new_content"].formatted_body=w));return function(e,t){t&&(e["m.relates_to"]=x(x({},e["m.relates_to"]||{}),t))}(k,d?x(x({},n),{},{rel_type:"m.replace",event_id:c.getId()}):n),!d&&s&&o&&(0,_.fh)(k,s,{permalinkCreator:o,includeLegacyFallback:i}),k}var E=n("./node_modules/matrix-react-sdk/src/SlashCommands.tsx"),w=n("./node_modules/matrix-react-sdk/src/editor/commands.tsx"),A=n("./node_modules/matrix-react-sdk/src/dispatcher/actions.ts"),O=n("./node_modules/matrix-react-sdk/src/components/views/rooms/SendMessageComposer.tsx");const P=["roomContext","mxClient"];async function C(e,t,n){var u;let{roomContext:p,mxClient:y}=n,g=(0,s.A)(n,P);const{relation:f,replyToEvent:h,permalinkCreator:v}=g,{room:x}=p,T=null==x?void 0:x.roomId;if(!T)return;const C={eventName:"Composer",isEditing:!1,messageType:"Text",isReply:Boolean(h),inThread:(null==f?void 0:f.rel_type)===r.THREAD_RELATION_TYPE.name};o.Vo.instance.trackEvent(C);let R=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(b)){const{cmd:t,args:n}=(0,E.OE)(e);if(t){const e=(null==f?void 0:f.rel_type)===r.THREAD_RELATION_TYPE.name?null==f?void 0:f.event_id:null;let s;if([R,s]=await(0,w.m8)(y,t,n,T,null!=e?e:null),!s)return;if(!R||t.category!==E.ge.messages&&t.category!==E.ge.effects)return;var M,j;(0,O.gV)(R,f),h&&(0,_.fh)(R,h,{permalinkCreator:v,includeLegacyFallback:null===(M=null===(j=R.msgtype)||void 0===j?void 0:j.startsWith("m."))||void 0===M||M})}else{const t=await(0,w.d8)(e);if(m.Ay.dispatch({action:A.r.FocusAComposer,context:p.timelineRenderingType}),!t)return}}if(null!==(u=R)&&void 0!==u||(R=await k(e,t,g)),!R.body.trim())return;a.A.getValue("Performance.addSendMessageTimingMetadata")&&(0,i.H)(R);const S=null!=f&&f.event_id&&(null==f?void 0:f.rel_type)===r.THREAD_RELATION_TYPE.name?f.event_id:null,D=(0,c.Y)(T,(e=>y.sendMessage(e,S,R)),y);return h&&m.Ay.dispatch({action:"reply_to_event",event:null,context:p.timelineRenderingType}),m.Ay.dispatch({action:"message_sent"}),d.y.forEach((e=>{if(R&&(0,l._)(R,e.emojis)){(null==f?void 0:f.rel_type)!==r.THREAD_RELATION_TYPE.name&&m.Ay.dispatch({action:`effects.${e.command}`})}})),a.A.getValue("Performance.addSendMessageTimingMetadata")&&D.then((e=>{(0,i._)(y,T,e.event_id)})),a.A.getValue("scrollToBottomOnMessageSent")&&m.Ay.dispatch({action:"scroll_to_bottom",timelineRenderingType:p.timelineRenderingType}),D}async function R(e,{roomContext:t,mxClient:n,editorStateTransfer:s}){const r=s.getEvent();o.Vo.instance.trackEvent({eventName:"Composer",isEditing:!0,messageType:"Text",inThread:Boolean(null==r?void 0:r.getThread()),isReply:Boolean(r.replyEventId)});const a=await k(e,!0,{editedEvent:r}),i=a["m.new_content"];if(""===(null==i?void 0:i.body))return(0,p.r)(n,s),void(0,u.Q)({mxEvent:r,onCloseDialog:()=>{(0,p.w)(t)}});let c;const d=r.getRoomId();if(function(e,t){const n=t.getEvent().getContent();return n.msgtype!==e.msgtype||n.body!==e.body||n.format!==e.format||n.formatted_body!==e.formatted_body}(i,s)&&d){(0,p.r)(n,s);const e=s.getEvent().threadRootId||null;c=n.sendMessage(d,e,a),m.Ay.dispatch({action:"message_sent"})}return(0,p.w)(t),c}}}]);
//# sourceMappingURL=1255.js.map